# Launching Preconfigured Jenkins Agents

Jenkins agents are recommended to be deployed using docker. There are several agents available on [Jenkins | Docker Hub](https://hub.docker.com/u/jenkins) under the repository names: `jenkins/jnlp-agent-*`. These preconfigured agents are good for a lot of worlflows but sometimes we need an agent that has a very specific runtime packages, for example we might need an python agent that runs `python-3.10` specifically. In such scenarios we must build and attach a custom Jenkins agent.

Before proceeding, lets look at how to attach a pre-configured agent from Docker Hub to the master node.



## Configure agent on Master Node

> [!NOTE]
> I will be using the [__Python3__](https://hub.docker.com/r/jenkins/jnlp-agent-python3) agent which comes with the latest version of Python _(3.12)_.

1. Login to Jenkins Server
2. Create a new Node, _Manage Jenkins_ > _Nodes_ > _New Node_
3. Now you will have to fill up the details for setting up the Node.
4. I will name the Node _python3_ and select it as a __Permanent Agent__.
5. Change the _Number of executors_ according to your needs, it controls the number of parallel jobs the node is allowed to handle.
6. Change the _Remote root directory_ to `/home/jenkins/agent` and give it a label _python3_.

> [!TIP]
> The label will be used when building Jenkins pipelines

7. Change the _Usage_ to _Only build jobs with label expressions matching this node_. 
8. Click on _Save_ to save the configuration & create a node.
9. You will be redirected to the _Nodes_ page where you can see the newly created node but the system metrics will show `N/A` indicating that the master cannot connect with the agent.
10. Click on the newly created node to get the following command: `java -jar agent.jar -url http://localhost:8080/ -secret e71a8f85dcbaab621d0ea0dc647b60b7c496b441fd97c88d12cfa9a4f42049c4 -name python3 -workDir "/home/jenkins/agent"`. Note down the parameter values for `secret` and `name`.

> [!CAUTION]
> It is advised to handle the values of `secret` and `name` parameters carefully as they are unique to each agent created on the Jenkins master server.

## Quick Follow up

Before we proceed any further, I want to share some details about my Jenkins deployment so that you, the reader and me are on the same page, this ensures that you can understand the following commands much better.

 I have deployed the Jenkins CI server on a docker container named `jenkins-master` which is attached to a docker network named `jenkins-vnet`.
I have used the commands mentioned on [my guide](./standalone-docker.md#deploy-jenkins-server) to deploy the Jenkins server.

## Launch Agent

1. Pull the docker image for the python agent. ([Docker Repository](https://hub.docker.com/r/jenkins/jnlp-agent-python3))
```bash
$ docker pull jenkins/jnlp-agent-python3
```
2. Run the following docker command:
```bash
$ docker run -d --rm --init \
--name=python3 --network=jenkins-vnet \
jenkins/jnlp-agent-python3 \
-url=http://jenkins-master:8080 \
-workDir=/home/jenkins/agent \
-secret=e71a8f85dcbaab621d0ea0dc647b60b7c496b441fd97c88d12cfa9a4f42049c4 \
-name=python3
```

3. Refresh the _Nodes_ page, you should see system metrics for the agent if the launch was successful, otherwise run `docker logs python3` to check the logs.

## Explaining the Launch command

+ `docker run` is self-explanatory, used to spin up a Docker container.
+ `-d` runs the container in detached mode which means we can keep on using the terminal,`--init` runs the init process inside the container and `--rm` flag tells docker to delete the container if it stops.
+ `--name=python3` assigns a name to the container so that we don't need to use the container ID to check the logs or access the shell of the container.
+ `--network=jenkins-vnet` attaches the container to the network `jenkins-vnet` which the master server is also attached to.
+ `jenkins/jnlp-agent-python3` is the docker image to use.
+ `-url`: URL of the master server.
+ `-workDir`: Working Directory where all data will be stored
+ `-secret`: unique agent key generated by the jenkins server after an agent has been created on it.
+ `-name`: name of the agent assigned by the jenkins server.

> [!TIP]
> This completes the deployment process. [Click Here](../README.md#contents) to go back to Homepage.